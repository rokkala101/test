name: Upload and Process Only New Files on Azure VM

on:
  push:
    branches:
      - main
    paths:
      - 'test/**'  # Trigger only when files in this folder change

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4


      - name: Identify Newly Added or Modified Files
        id: new_files
        run: |
          git fetch origin main --depth=2
          git diff --name-only HEAD^ HEAD --diff-filter=A > new_files.txt  # A = Added files
          echo "NEW_FILES=$(cat new_files.txt)" >> $GITHUB_ENV
          
          
      - name: Print New Files
        run: |
          echo "New files to upload:"
          cat new_files.txt

      - name: Install SSH Client
        run: sudo apt-get install -y openssh-client sshpass

      - name: Upload Only New Files to Azure VM
        if: env.NEW_FILES != ''
        run: |
          for file in ${{ env.NEW_FILES }}; do
            sshpass -p "${{ secrets.AZURE_VM_PASSWORD }}" scp -o StrictHostKeyChecking=no "$file" "${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_IP }}:/home/${{ secrets.AZURE_VM_USERNAME }}/uploads/"
          done

      - name: Run Python Processing Script on Azure VM
        if: env.NEW_FILES != ''
        run: |
          sshpass -p "${{ secrets.AZURE_VM_PASSWORD }}" ssh -o StrictHostKeyChecking=no "${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_IP }}" "python3 /home/${{ secrets.AZURE_VM_USERNAME }}/process_file.py"
